<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name = "format-detection" content = "telephone=no" />
	<title>Entrega de documentos</title>

	<link rel="stylesheet" href="css/vendor/jquery.mobile-1.4.5.css">
	<link rel="stylesheet" href="css/vendor/jquery.mobile.theme-1.4.5.css">
	<link rel="stylesheet" href="css/vendor/font-awesome.min.css">
	<link rel="stylesheet" href="css/vallen.css">
	<link rel="stylesheet" href="css/styles.css">
	
	<script src="js/jquery-1.8.3.min.js" type="text/javascript"></script>
	<script src="js/vendor/jquery-2.1.4.min.js" type="text/javascript"></script>
	<script src="js/vendor/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>

</head>
<body>

	<div id="preloader">
	</br></br></br></br></br></br></br></br></br><p id="contenido">
	<div id="loader">&nbsp;</div>
</div>

<section data-role="page" class="h100">

	<div class="map-route">
		<a href="#popDetalles" id="boton" data-rel="popup" class="btn-pop pdetalles" data-transition="pop"><i class="fa fa-info"></i></a>

		<a href="" id="botonrefresh" data-rel="popup" class="btn-pop pindicaciones" data-transition="pop"><i class="fa fa-refresh"></i></a>

		<div id="map-canvas"></div>

		<div class="footer footer-hidden" id="botones">

			<a href="" class="btn-play" rel="external" data-role="button" data-theme="b" id="startroute">Iniciar ruta <i class="fa fa-play-circle"></i></a>

			<div class="ui-grid-a mensajes-tareas" id="mensajesComplete">
				<div class="ui-block-a">
					<a href="javascript:btnCompletada();" data-rel="popup" data-position-to="window" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-check ui-btn-icon-left ui-btn-d" data-transition="pop">Completado</a>
				</div>
				<div class="ui-block-b">
					<a href="#popupNoCompletada" data-rel="popup" data-position-to="window" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-delete ui-btn-icon-left ui-btn-c" data-transition="pop">No Completado</a>
				</div>
			</div>

		</div>
	</div>

	<div data-role="popup" id="popDetalles">
		<a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
		<div class="info-detail" id="INFO_PARADA">

		</div>
	</div>

	<div data-role="popup" id="popIndicaciones">
		<a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
		<div class="info-detail">            
			<div id="right-panel"></div>
		</div>
	</div>

	<div data-role="popup" id="popupCompletada" data-theme="d" class="ui-corner-all">
		<a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-d ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
		<form id="comentario-final-form" name="comentario-final-form" action="">
			<div style="padding:10px 20px;">
				<h3>Comentarios</h3>
				<textarea name="COMENTARIO_COMPLETADA_FINAL" id="COMENTARIO_COMPLETADA_FINAL" cols="30" rows="10"></textarea>
				<a id="btn_COMENTARIO_FINAL" class="ui-btn ui-corner-all ui-shadow ui-btn-d ui-btn-icon-left ui-icon-check" href="javascript:ComentarioFinal();" rel="external" data-role="button">Guardar</a>
			</div>
		</form>
	</div>

	<div data-role="popup" id="popupNoCompletada" data-theme="c" class="ui-corner-all" >
		<a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
		<form>
			<div style="padding:10px 20px;">
				<select name="MotivoCancelacion" id="MotivoCancelacion">
					<option value="" selected>Motivo de cancelación</option>
					<option value="1">Error en dirección de entrega</option>
					<option value="2">No es el material que el Cliente requiere</option>
					<option value="3">Mal surtido (Almacen)</option>
					<option value="4">Horarios de recibo de Cliente</option>
					<option value="5">Días de recibo de Cliente</option>
					<option value="6">Material duplicado</option>
					<option value="7">Error de Facturacion</option>
					<option value="8">Error en Orden de Compra</option>
					<option value="9">Error de entrega de Chofer</option>
					<option value="10">Material incompleto </option>
					<option value="11">Material en mal estado</option>
					<option value="12">Material caduco</option>
				</select>


				<label for="REPROGRAMAR">Reprogramar</label>
				<input type="checkbox" name="REPROGRAMAR" id="REPROGRAMAR">


				<div class="ui-grid-a" id="GRUPO_FECHA_REPROGRAMAR" style="display:none">
					<div class="ui-block-a">
						<label for="FECHA_REPROGRAMAR" data-icon="calendar" data-iconpos="left" data-mini="true" data-inline="true" class="ui-link ui-btn ui-icon-calendar ui-btn-icon-left ui-btn-inline ui-shadow ui-corner-all top6" role="label">Fecha</label>
					</div>
					<div class="ui-block-b">
						<input type="date"  data-inline="true" name="FECHA_REPROGRAMAR" id="FECHA_REPROGRAMAR" placeholder="dd/mm/aaaa" value="">
					</div>
				</div>

				<div class="ui-grid-a" id="GRUPO_HORA_REPROGRAMAR" style="display:none">
					<div class="ui-block-a">
						<label for="HORA_REPROGRAMAR" data-icon="clock" data-iconpos="left" data-mini="true" data-inline="true" class="ui-link ui-btn ui-icon-clock ui-btn-icon-left ui-btn-inline ui-shadow ui-corner-all" role="label top6">Hora</label>
					</div>
					<div class="ui-block-b">
						<input type="time" data-inline="true" name="HORA_REPROGRAMAR" id="HORA_REPROGRAMAR" placeholder="dd/mm/aaaa" value="">
					</div>
				</div>

				<textarea name="COMENTARIO_NO_COMPLETADA_FINAL" id="COMENTARIO_NO_COMPLETADA_FINAL" cols="30" rows="10" placeholder="Comentarios de la Cancelación"></textarea>
				<a id="btn_COMENTARIO_NO_COMPLETADA_FINAL" class="ui-btn ui-corner-all ui-shadow ui-btn-c ui-btn-icon-left ui-icon-check" href="javascript:ComentarioNoFinal();" rel="external">Guardar</a>
			</div>
		</form>
	</div>

	<div data-role="popup" id="avisoUbicacion">
		<div data-role="main" class="ui-content">
			<div style="padding:10px 20px;">
				<p>Dirección no localizada:</p>
				<label id="detalleDireccion"></label>
				<label id="detalleDireccionb"></label>
				<p>¿Deseas continuar y guardar la ubicación al finalizar el recorrido?</p>
				<a class="ui-btn ui-corner-all ui-shadow ui-btn-d ui-btn-icon-left ui-icon-check" href="javascript:IniciarRecorridoManual();" rel="external" data-role="button">Aceptar</a>
				<a class="ui-btn ui-corner-all ui-shadow ui-icon-delete ui-btn-icon-left ui-btn-c" href="javascript:window.location='ruta.html';" rel="external" data-role="button">Cancelar</a>
			</div>
		</div>
	</div>

	<div data-role="popup" id="avisoConfirmacionRutaManual">
		<div data-role="main" class="ui-content">
			<div style="padding:10px 20px;">
				<p>¿Deseas finalizar el recorrido y guardar la ubicación actual?</p>
				<a class="ui-btn ui-corner-all ui-shadow ui-btn-d ui-btn-icon-left ui-icon-check" href="javascript:FinalizarRecorridoManual();" rel="external" data-role="button">Aceptar</a>
				<a class="ui-btn ui-corner-all ui-shadow ui-icon-delete ui-btn-icon-left ui-btn-c" href="javascript:CancelarRecorridoManual();" rel="external" data-role="button">Cancelar</a>
			</div>
		</div>
	</div>

	<div data-role="footer" data-position="fixed">
	</div>

</section>

<script type="text/javascript" src="phonegap.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3&language=es&key=AIzaSyAxVEXLMQTw73x9oObItBBIuYPg0DCDnC4"></script>
<script src="js/main_map.js"></script>
<script src="js/RUTA_COMPLETADA/index.js"></script>
<script src="js/RUTA_NO_COMPLETADA/index.js"></script>

<script>
	function restarHoras(inicio,fin) {
		var fechaInicio = new Date(inicio);
		var fechaFin = new Date(fin);
		var dif= fechaFin - fechaInicio; 
		var difSeg = Math.floor(dif/1000);
            var segundos = difSeg % 60; //segundos
            var difMin = Math.floor(difSeg/60); 
            var minutos = difMin % 60; //minutos
            var difHs = Math.floor(difMin/60);
            var horas = difHs % 24; //horas
            return horas+":"+minutos; 
        }

        var ID_PARAD=sessionStorage.getItem('ID_PARADA')||localStorage.getItem("ID_PARADA");
        var db = window.openDatabase("RUTA", "1.0", "DATABASE", -1);
        db.transaction(function(tx){
        	tx.executeSql('SELECT * FROM PARADA WHERE ESTATUS_PARADA="En Ruta" ORDER BY ID ASC', [], function(tx, results) {
        		var val=results.rows.length;
        		if(val>0){
        			$('#botones').hide();
        		}
        	},null);	
        });
        db.transaction(function(tx){
        	tx.executeSql('SELECT * FROM PARADA WHERE ESTATUS_PARADA="En Ruta" AND ID_PARADA='+ID_PARAD, [], function(tx, results) {
        		var val2=results.rows.length;
        		if(val2>0){
        			$('#botones').show();
        			$('#mensajesComplete').css('display','block');
        			$('#startroute').css('display','none');
        			recorrido();	
        		}
        	},null);	
        });

        $(function() {
        	sessionStorage.setItem("RutaManual",0);
        	$('#REPROGRAMAR').on('click', function(){
        		if($("#REPROGRAMAR").is(':checked')) {  
        			$('#GRUPO_FECHA_REPROGRAMAR').css('display','block');
        			$('#GRUPO_HORA_REPROGRAMAR').css('display','block');
        		}else{
        			$('#GRUPO_FECHA_REPROGRAMAR').css('display','none');
        			$('#GRUPO_HORA_REPROGRAMAR').css('display','none');
        		}
        	});
        	$('#startroute').on('click', function(){
        		var g= new Date();	
        		var hora=g.getHours();
        		var minuto=g.getMinutes();
        		var dia=g.getDate();
        		var mes=g.getMonth()+1;
        		if (g.getHours()<10) {
        			hora="0"+hora;
        		}
        		if(g.getMinutes()<10){
        			minuto="0"+minuto;
        		}
        		if(g.getDate()<10){
        			dia="0"+dia;
        		}
        		if(g.getMonth()<10){
        			mes="0"+mes;
        		}
        		var horai=g.getFullYear()+"-"+mes+"-"+dia+" "+hora+":"+minuto;
        		var r = confirm("Confirma el inicio de esta tarea.");
        		if (r == true) {
        			$('#mensajesComplete').css('display','block');
        			$('#startroute').css('display','none');
        			IniciarRecorrido();
        		};
        		var db = window.openDatabase("RUTA", "1.0", "DATABASE", -1); 
        		db.transaction(function(tx){
        			tx.executeSql('UPDATE PARADA_T SET HORARIO_INICIO ="'+horai+'" WHERE ID_PARADA='+sessionStorage.getItem('ID_PARADA'));
        		});

        	});

        	$('#botonrefresh').on('click', function(){
        		location.reload();
        	});
        	ID_USUARIO=sessionStorage.getItem('ID_USUARIO')||localStorage.getItem("ID_USUARIO");;
        	ID_PARADA=sessionStorage.getItem('ID_PARADA')||localStorage.getItem("ID_PARADA");
        	if(ID_USUARIO==0 || ID_PARADA==0){
        		window.location="index.html"
        	}else{
        		DetallesParada(ID_PARADA);
        	};
        });
        function DetallesParada(ID_PARADA){
        	$.ajax({
        		url:'http://recorridos.vallen.mx/SIS/DetallesParada/index.asp',
        		data:{ID_PARADA:ID_PARADA},
        		type:'get',
        		dataType: 'jsonp',
        		callbackParameter: 'callback',
        		success: function(data){
        			$.each(data.datos, function(i,item){
        				var ESTADO_CONSULTA=item.ESTADO_CONSULTA||'';
        				var	REFERENCIA_PARADA=item.REFERENCIA_PARADA||'';
        				var	DESCRIPCION_PARADA=item.DESCRIPCION_PARADA||'';
        				var	ESTATUS_PARADA=item.ESTATUS_PARADA||'Estatus sin definir';
        				var	HORARIO_ENTREGA=item.HORARIO_ENTREGA||'Horario sin definir';
        				var	DOMICILIO=item.DOMICILIO||'Dirección sin definir';
        				var	CIUDAD_PARADA=item.CIUDAD_PARADA||'Ciudad sin definir';
        				var	ESTADO_PARADA=item.ESTADO_PARADA||'Estado sin definir';
        				var	TIPO_PARADA=item.TIPO_PARADA||'Tipo de parada sin definir';
        				var	LAT_DESTINO=item.LATITUD_PARADA||0;
        				var	LON_DESTINO=item.LONGITUD_PARADA||0;
        				sessionStorage.setItem("LAT_DESTINO",LAT_DESTINO)
        				sessionStorage.setItem("LON_DESTINO",LON_DESTINO)
        				sessionStorage.setItem("ESTATUS_PARADA",ESTATUS_PARADA)
        				var domicilioCompleto=DOMICILIO;
        				$('#detalleDireccion').html(domicilioCompleto)
        				var domicilioCiudadEstado=CIUDAD_PARADA+' '+ESTADO_PARADA;
        				$('#detalleDireccionb').html(domicilioCiudadEstado)
        				var INFO = ''
        				INFO+="	<div class='ui-grid-b title-header'>"
        				INFO+="<h3>"+TIPO_PARADA+"</h3>"
        				INFO+="<div class='scroll-info'>"
        				INFO+="    <ul>"
        				INFO+="        <li>Referencia: "+REFERENCIA_PARADA+"</li>"
        				INFO+="        <li>Horario: "+HORARIO_ENTREGA+"</li>"
        				INFO+="        <li>Dirección:</li>"
        				INFO+="        <li>"+DOMICILIO+"</li>"
        				INFO+="        <li>"+CIUDAD_PARADA+","+ESTADO_PARADA+"</li>"
        				INFO+="    </ul>"
        				INFO+="    <h3>Descripción:</h3>"
        				INFO+="    <p>"+DESCRIPCION_PARADA+"</p>"
        				INFO+="</div>"
        				$("#INFO_PARADA").html(INFO);
        				initLocationProcedure();
        			})	
        		}
        	});
        };		
        $(window).load(function() {
			//$("#botones").removeClass("footer-hidden");
			if(sessionStorage.getItem('PARADAOFF')==1){
				var load= document.getElementById("contenido");
				load.innerHTML='<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Recuperando &nbsp;Internet</p><br><br><br><br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sincronizando';
				load.style.top=(load.offsetTop+700)+"px";
				sessionStorage.setItem('PARADAOFF',0);
			}
			$('#preloader').fadeOut('slow');
			
			var today = new Date();
			var dd = today.getDate();
			var mm = today.getMonth()+1;
			var yyyy = today.getFullYear();
			if(dd<10){
				dd='0'+dd
			} 
			if(mm<10){
				mm='0'+mm
			} 
			var today = yyyy+'-'+mm+'-'+dd;
			$('#FECHA_REPROGRAMAR').val(today);
			
			var hour = new Date().getHours() % 24 || 24;
			if(hour<10){
				hour='0'+hour
			} 
			var minute = new Date().getMinutes();
			if(minute<10){
				minute='0'+minute
			} 
			var second = new Date().getSeconds();
			if(second<10){
				second='0'+second
			} 
			var ampm = hour >= 12 ? 'p.m.' : 'a.m.';
			var tohour = hour+':'+minute;
			
			$('#HORA_REPROGRAMAR').val(tohour);
		});	
        $(document).bind('mobileinit',function(){
        	$.mobile.changePage.defaults.changeHash = false;
        	$.mobile.hashListeningEnabled = false;
        	$.mobile.pushStateEnabled = false;
        });
        function IniciarRecorridoManual(){
        	sessionStorage.setItem("RutaManual",1);
        	$("#avisoUbicacion").popup('close');
        	$("#botones").show();
        	$('#mensajesComplete').css('display','block');
        	$('#startroute').css('display','none');
        	IniciarRecorrido();
        }
        function btnCompletada(){
        	var rutamanual = sessionStorage.getItem('RutaManual')||0;
        	if(rutamanual==1){
        		$("#avisoConfirmacionRutaManual").popup('open');
        	}else{
        		$("#popupCompletada").popup('open');
        	}
        }
        function FinalizarRecorridoManual(){
        	$("#avisoConfirmacionRutaManual").popup('close');
        	setTimeout(function(){ $("#popupCompletada").popup('open'); }, 500);
        }
        function CancelarRecorridoManual(){
        	$("#avisoConfirmacionRutaManual").popup('close');
        }
        function initLocat() {
        	navigator.geolocation.getCurrentPosition(checkConnect);
        }
        function checkConnect() {
        	var networkState = navigator.connection.type;

        	var states = {};
        	states[Connection.UNKNOWN]  = 'Unknown connection';
        	states[Connection.ETHERNET] = 'Ethernet connection';
        	states[Connection.WIFI]     = 'WiFi connection';
        	states[Connection.CELL_2G]  = 'Cell 2G connection';
        	states[Connection.CELL_3G]  = 'Cell 3G connection';
        	states[Connection.CELL_4G]  = 'Cell 4G connection';
        	states[Connection.CELL]     = 'Cell generic connection';
        	states[Connection.NONE]     = 'No network connection';
        	sessionStorage.setItem('CONNECTI',states[networkState]);
        	if(states[networkState]=='No network connection'){
        		sessionStorage.setItem('ID_PARADA',ID_PARADA);
        		top.location="paradaoff.html"
        	}
        }
        initLocat();
        setInterval(function() {
        	initLocat();
        }, 10000);

        function completa(){
        	var COMENTARIO_FINAL = $('#COMENTARIO_COMPLETADA_FINAL').val();	
        	var db = window.openDatabase("RUTA", "1.0", "DATABASE", -1);
        	db.transaction(function(tx){
        		tx.executeSql('UPDATE PARADA SET ESTATUS_PARADA= "Completada",COMENTARIO_FINAL="'+COMENTARIO_FINAL+'" WHERE ID_PARADA= '+ID_PARADA);
        	});
        	location.href='ruta.html';		
        }
        function nocompleta(){
        	var COMENTARIO_FINAL = $('#COMENTARIO_NO_COMPLETADA_FINAL').val();
        	var ID_CANCELACION = $('#MotivoCancelacion').val();
        	var REPROGRAMAR_PARADA = 0;
        	if($("#REPROGRAMAR").is(':checked')) {  
        		REPROGRAMAR_PARADA=1
        	}

        	var FECHA_REPROGRAMAR = $('#FECHA_REPROGRAMAR').val();
        	var HORA_REPROGRAMAR  = $('#HORA_REPROGRAMAR').val();

        	var db = window.openDatabase("RUTA", "1.0", "DATABASE", -1); 	
        	db.transaction(function(tx){
        		tx.executeSql('UPDATE PARADA SET ESTATUS_PARADA= "Cancelada", COMENTARIO_FINAL="'+COMENTARIO_FINAL+'",ID_CANCELACION='+ID_CANCELACION+',REPROGRAMAR="'+REPROGRAMAR_PARADA+'", FECHA_REPROGRAMAR="'+FECHA_REPROGRAMAR+'", HORA_REPROGRAMAR="'+HORA_REPROGRAMAR+'" WHERE ID_PARADA= '+ID_PARADA);
        	});
        	location.href='ruta.html';	
        }
        document.addEventListener("deviceready", onDeviceReady, false);

        var LATITUDE_ANTERIOR2='0';
        var LONGITUDE_ANTERIOR2='0', contador=0;
        function onDeviceReady() {
              // Android customization
              cordova.plugins.backgroundMode.setDefaults({ text:'Realizando tareas.'});
              // Enable background mode
              cordova.plugins.backgroundMode.enable();
              // Called when background mode has been activated


              cordova.plugins.backgroundMode.onactivate = function () {
                  // Modify the currently displayed notification
                  setTimeout(function () {
                  // Modify the currently displayed notification
                  cordova.plugins.backgroundMode.configure({
                    title: 'Ejecutándose en segundo plano.'
                });
              }, 3000);
                  setInterval(function() {                 
                    var valor=cordova.plugins.backgroundMode.isActive();
                    if(valor){
                        var callbackFn = function(location) {
                            if (sessionStorage.getItem('ESTATUS_PARADA')=='En Ruta'){
                                lat=location.latitude;
                                lng=location.longitude;
                                currentPositionMarker.setIcon(image_send2);
                                ID=sessionStorage.getItem('ID_PARADA');
                                $.ajax({
                                    url:'http://recorridos.vallen.mx/SIS/ReportarUbicacion/index.asp',
                                    data:{ID_PARADA:ID,latitude:lat,longitude:lng},
                                    type:'get',
                                    dataType: 'jsonp',
                                    callbackParameter: 'callback',
                                    success: function(data){
                                        $.each(data.datosB, function(j,itemB){
                                            var ESTADO_CONSULTA=itemB.ESTADO_CONSULTA||'',
                                            LATITUDE_ANTERIOR2=itemB.latitude_ANTERIOR||'',
                                            LONGITUDE_ANTERIOR2=itemB.longitude_ANTERIOR||'';
                                            currentPositionMarker.setIcon(image);
                                        })
                                    }
                                });
                            }
                            backgroundGeolocation.finish();
                        };
                        var failureFn = function(error) {
                            alert('BackgroundGeolocation error');
                        };
                        backgroundGeolocation.configure(callbackFn, failureFn, {
                            desiredAccuracy: 10,
                            stationaryRadius: 20,
                            distanceFilter: 30,
                            interval: 60000
                        });
                        backgroundGeolocation.start();
                    }else{
                        cordova.plugins.backgroundMode.disable();
                        backgroundGeolocation.stop(); 
                    } 
                }, 2000);

              }
          }
          document.addEventListener("pause",onPause,false);
          function onPause() {
            $timeout(function() {
                console.log("Ejecutándose en segundo plano");
            }, 5000);
        };
    </script>
</body>
</html>